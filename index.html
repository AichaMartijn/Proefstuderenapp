<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Proefstuderen â€“ Inschrijven & Dashboard</title>

<link rel="icon" href='data:image/svg+xml;utf8,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <text y="50" font-size="52">ðŸ¦‹</text>
</svg>' />

 
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --primary:#22c55e; --danger:#ef4444; --accent:#38bdf8;
    --text:#e5e7eb; --soft:#1f2937; --ring:#334155;
    --secondary-bg:#374151; --secondary-border:#4b5563; --secondary-text:#e5e7eb;
  }
  *{box-sizing:border-box} body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    background:linear-gradient(180deg,#0b1220 0%, #0f172a 100%); color:var(--text);
  }
  header{padding:20px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    position:sticky; top:0; background:rgba(15,23,42,.8); backdrop-filter:saturate(180%) blur(10px); border-bottom:1px solid #1f2937}
  h1{font-size:18px; margin:0}
  .pill{font-size:12px; color:#a5b4fc; background:#111827; padding:6px 10px; border:1px solid #1f2937; border-radius:999px}
  main{max-width:1100px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns:1.1fr .9fr; gap:20px}
  .card{background:var(--card); border:1px solid var(--soft); border-radius:16px; padding:18px}
  .card h2{margin:0 0 12px 0; font-size:18px}
  label{display:block; font-size:14px; color:var(--muted); margin:10px 0 6px}
  input,select{
    width:100%; background:#0b1220; border:1px solid var(--ring); color:var(--text);
    padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
  }
  input:focus,select:focus{border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.15)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px;
    border:1px solid #1f2937; cursor:pointer; user-select:none; font-weight:600; transition:transform .02s ease}
  .btn:active{transform:translateY(1px)}
  .primary{background:var(--primary); color:#062a12; border-color:#16a34a}
  .secondary{background:var(--secondary-bg); border-color:#4b5563; color:#e5e7eb}
  .danger{background:#ef4444; border-color:#b91c1c}
  .accent{background:#38bdf8; color:#062a12; border-color:#0891b2}
  small{color:var(--muted)}
  .grid{display:grid; gap:8px}
  .lessons{display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px}
  .lesson{background:#0b1220; border:1px solid var(--ring); border-radius:10px; padding:10px}
  .lesson h4{margin:0 0 6px 0; font-size:14px}
  .cap{font-size:12px; color:#a3e635}
  .full{color:#fca5a5}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid #1f2937}
  .CVD{background:#0a1f1a; color:#86efac; border-color:#14532d}
  .DBI{background:#0a1a21; color:#7dd3fc; border-color:#0e7490}
  .muted{opacity:.75}
  table{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px}
  th,td{border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left}
  th{color:#a5b4fc; position:sticky; top:0; background:#0f172a}
  .right{text-align:right}
  .kicker{font-size:12px; color:#93c5fd}
  .flex{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#0b1220; border:1px dashed #334155; padding:8px 10px; border-radius:8px}
  .footer{margin:24px auto; max-width:1100px; padding:0 16px 40px; color:#94a3b8; font-size:12px}
  .hint{font-size:12px;color:#a1a1aa}
  @media (max-width:960px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <h1>Proefstuderen â€“ Inschrijven</h1>
  <span class="pill">Week 6 Â· OP1 Â· CVD & DBI</span>
</header>

<main>
  <!-- INSCHRIJVEN -->
  <section class="card">
    <h2>Boeking maken</h2>

    <div class="row">
      <div>
        <label>Voor- en achternaam</label>
        <input id="name" placeholder="Bijv. Sam Student" />
      </div>
      <div>
        <label>Studentnummer</label>
        <input id="sid" inputmode="numeric" pattern="[0-9]*" placeholder="Bijv. 1234567" />
      </div>
    </div>

    <!-- Verplicht e-mail -->
    <div class="row">
      <div>
        <label>E-mail (verplicht)</label>
        <input id="email" type="email" placeholder="bijv. naam@student.hva.nl" required />
        <small class="muted">Gebruik je schoolmail a.u.b.</small>
      </div>
      <div></div>
    </div>

    <!-- Track interesse â€“ Ã©Ã©nmalig -->
    <div id="trackBlock">
      <label>Track (meest interessant) â€” Ã©Ã©nmalig</label>
      <div class="row">
        <div>
          <select id="track">
            <option value="">Kiesâ€¦</option>
            <option>Creating Value for Data (CVD)</option>
            <option>Digital Business Innovation (DBI)</option>
            <option>Cybersecurity (interesse)</option>
          </select>
        </div>
        <div class="flex" style="margin-top:0">
          <button class="btn secondary" id="saveTrackBtn">Sla track op</button>
          <small class="hint">Je kunt deze keuze later niet meer wijzigen.</small>
        </div>
      </div>
    </div>
    <div id="trackLock" style="display:none">
      <label>Track (vastgelegd)</label>
      <input id="trackFixed" disabled class="hint" />
      <small class="hint">Wil je dit aanpassen? Mail de coÃ¶rdinator.</small>
    </div>

    <label style="margin-top:8px">Proeflesmoment</label>
    <select id="lesson"></select>
    <small class="muted">Maximaal 2 boekingen per student Â· CVD max. 4 p/les Â· DBI max. 16 p/les</small>

    <div class="flex" style="margin-top:12px">
      <button class="btn primary" id="bookBtn">Boek plek</button>
      <span id="bookMsg"></span>
    </div>

    <hr style="border:none;border-top:1px solid #1f2937; margin:16px 0" />

    <h2>Zelf annuleren</h2>
    <div class="row">
      <div>
        <label>Studentnummer</label>
        <input id="cancelSid" inputmode="numeric" pattern="[0-9]*" placeholder="1234567" />
      </div>
      <div>
        <label>Boekingscode</label>
        <input id="cancelCode" placeholder="bijv. X7F2-9PKD" />
      </div>
    </div>
    <div class="flex" style="margin-top:12px">
      <button class="btn danger" id="cancelBtn">Annuleer mijn boeking</button>
      <small class="muted">Code staat in je bevestiging (getoond na boeken).</small>
    </div>

    <div class="card" style="margin-top:16px; background:#0b1220">
      <div class="kicker">Beschikbaarheid (live)</div>
      <div id="availability" class="lessons"></div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section class="card">
    <h2>Dashboard (coÃ¶rdinator)</h2>
    <div class="row">
      <div>
        <label>Admin-code</label>
        <input id="adminCode" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <div class="flex" style="margin-top:28px">
        <button class="btn secondary" id="loginBtn">Ontgrendel</button>
        <small class="muted">Voer de beheerdercode in om te ontgrendelen.</small>
      </div>
    </div>

    <div id="adminArea" style="display:none">
      <div class="flex" style="margin:10px 0 4px">
        <button class="btn secondary" id="exportCsv">Export CSV</button>
        <button class="btn secondary" id="exportJson">Export JSON</button>
        <label class="btn secondary">
          Import JSON <input type="file" id="importJson" accept="application/json" style="display:none">
        </label>
      </div>

      <div id="adminStats" class="grid"></div>

      <table id="adminTable">
        <thead>
          <tr>
            <th>Les</th><th>Naam</th><th>Studentnr</th><th>Track</th><th>E-mail</th><th>Code</th><th class="right">Actie</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<div class="footer">
  <p><strong>Info CVD (OP1):</strong> Ma: Statistiek 9â€“13 (KZ.B2.311 / KZ.D3.140) Â· Data Eng. 9â€“13 (KZ.C1.280) Â· Data Eng. 13â€“17 (KZ.B2.311). Wo: Statistiek 9:00â€“13 (KZ.D5.220 / KZ.C1.280) Â· Data Eng. 13:30â€“17:30 (KZ.C1.280) Â· Data Eng. 14â€“18 (KZ.D6.175).</p>
  <p><strong>Info DBI (OP1):</strong> Ma: Digitale Transformatie & Design Thinking (+ Onderzoeksvaardigheden) 9â€“14 (KZ.C0.150). Wo: Statistiek & AI 9â€“13 (KZ.C0.150). Vr: Projectmanagement & Feedback 9â€“14 (KZ.C0.150).</p>
</div>

<script>
/* =======================
   CONFIG â€“ pas hier aan
======================= */
const CONFIG = {
  // SHA-256 hash van je admin-code (hier staat de hash van @Ladygeek2025 als voorbeeld)
  ADMIN_CODE_HASH: "DEA4703805DC17616E36355E4F6D86699323655ED9B6168C1F5A3DE2D7CEC932",
  // <â€” vul hier jouw Apps Script Web App /exec-URL in:
  API_BASE: "https://script.google.com/macros/s/AKfycbw6JwROLuWY51KyUs_MEWBXPXUvDGpT-FZJPquMttI4vMoGTx2u8TERjXQ-ucsktjYG/exec",
  API_KEY:  "XyZ_Proef2025!",
  MAX_BOOKINGS_PER_SID: 2,
  lessons: [
    { id:"CVD-MA-STAT-1", track:"CVD", name:"CVD Â· Ma Â· Statistiek 09:00â€“13:00 (KZ.B2.311)", capacity:4 },
    { id:"CVD-MA-STAT-2", track:"CVD", name:"CVD Â· Ma Â· Statistiek 09:30â€“13:00 (KZ.D3.140)", capacity:4 },
    { id:"CVD-MA-DE-1",   track:"CVD", name:"CVD Â· Ma Â· Data Engineering 09:00â€“13:00 (KZ.C1.280)", capacity:4 },
    { id:"CVD-MA-DE-2",   track:"CVD", name:"CVD Â· Ma Â· Data Engineering 13:00â€“17:00 (KZ.B2.311)", capacity:4 },
    { id:"CVD-WO-STAT-1", track:"CVD", name:"CVD Â· Wo Â· Statistiek 09:00â€“13:00 (KZ.D5.220)", capacity:4 },
    { id:"CVD-WO-STAT-2", track:"CVD", name:"CVD Â· Wo Â· Statistiek 09:30â€“13:00 (KZ.C1.280)", capacity:4 },
    { id:"CVD-WO-DE-1",   track:"CVD", name:"CVD Â· Wo Â· Data Engineering 13:30â€“17:30 (KZ.C1.280)", capacity:4 },
    { id:"CVD-WO-DE-2",   track:"CVD", name:"CVD Â· Wo Â· Data Engineering 14:00â€“18:00 (KZ.D6.175)", capacity:4 },
    { id:"DBI-MA-DTDT",   track:"DBI", name:"DBI Â· Ma Â· Digitale Transformatie & Design Thinking (+ Onderzoeksvaardigheden) 10:00â€“14:00 (KZ.C0.150)", capacity:16 },
    { id:"DBI-WO-SAI",    track:"DBI", name:"DBI Â· Wo Â· Statistiek & AI 10:00â€“13:00 (KZ.C0.150)", capacity:16 },
    { id:"DBI-VR-PMF",    track:"DBI", name:"DBI Â· Vr Â· Projectmanagement & Feedback 10:00â€“14:00 (KZ.C0.150)", capacity:16 },
  ],
};
const STORAGE_KEY = "proefstuderen.bookings.v7";

/* ===== Helpers ===== */
function loadBookings(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); } catch(e){ return []; } }
function saveBookings(rows){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }
function normSid(v){ return String(v || '').replace(/\D+/g, ''); } // alleen cijfers
function lessonById(id){ return CONFIG.lessons.find(l=>l.id===id); }
function uid(len=4){ const s = Math.random().toString(36).slice(2).toUpperCase(); const s2 = Math.random().toString(36).slice(2).toUpperCase(); return `${s.slice(0,len)}-${s2.slice(0,len)}`; }
async function sha256Hex(str){ const enc = new TextEncoder().encode(str); const buf = await crypto.subtle.digest("SHA-256", enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("").toUpperCase(); }
function isValidEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||"").trim()); }

/* ===== DOM refs ===== */
const els = {
  lessonSel: document.getElementById("lesson"),
  availability: document.getElementById("availability"),
  bookBtn: document.getElementById("bookBtn"),
  bookMsg: document.getElementById("bookMsg"),
  name: document.getElementById("name"),
  sid: document.getElementById("sid"),
  email: document.getElementById("email"),
  track: document.getElementById("track"),
  trackBlock: document.getElementById("trackBlock"),
  trackLock: document.getElementById("trackLock"),
  trackFixed: document.getElementById("trackFixed"),
  saveTrackBtn: document.getElementById("saveTrackBtn"),
  cancelSid: document.getElementById("cancelSid"),
  cancelCode: document.getElementById("cancelCode"),
  cancelBtn: document.getElementById("cancelBtn"),
  adminCode: document.getElementById("adminCode"),
  loginBtn: document.getElementById("loginBtn"),
  adminArea: document.getElementById("adminArea"),
  adminTableBody: document.querySelector("#adminTable tbody"),
  adminStats: document.getElementById("adminStats"),
  exportCsv: document.getElementById("exportCsv"),
  exportJson: document.getElementById("exportJson"),
  importJson: document.getElementById("importJson"),
};

/* ===== Backend helpers ===== */
async function apiGet(params){
  const url = new URL(CONFIG.API_BASE);
  Object.entries(Object.assign({}, params, { key: CONFIG.API_KEY })).forEach(([k,v])=>url.searchParams.set(k,v));
  const res = await fetch(url.toString()); return res.json();
}
async function apiPost(formParams){
  const body = new URLSearchParams(Object.assign({}, formParams, { apiKey: CONFIG.API_KEY }));
  const res = await fetch(CONFIG.API_BASE, { method:"POST", body }); return res.json();
}

/* ===== Availability (server + local) ===== */
let _pendingAvail = null;
async function fetchCounts(){
  try{ const data = await apiGet({ op:"counts" }); return data.counts || {}; } catch(e){ return {}; }
}
function renderAvailabilityThrottled(){
  if(_pendingAvail) return;
  _pendingAvail = setTimeout(async ()=>{ _pendingAvail=null; const c = await getEffectiveCounts(); drawAvailability(c); }, 800);
}
async function getEffectiveCounts(){
  const localC = {}; CONFIG.lessons.forEach(l => localC[l.id]=0);
  loadBookings().forEach(b => { if(localC[b.lessonId]!=null) localC[b.lessonId]++; });
  const serverC = await fetchCounts();
  return Object.assign(localC, serverC);
}
function drawAvailability(c){
  els.availability.innerHTML = "";
  CONFIG.lessons.forEach(l=>{
    const used = c[l.id]||0, left = l.capacity - used;
    const box = document.createElement("div");
    box.className = "lesson";
    box.innerHTML = `
      <h4><span class="badge ${l.track}">${l.track}</span> ${l.name.replace(/^CVD Â· |DBI Â· /,'')}</h4>
      <div><span class="cap">${used}/${l.capacity}</span> bezet Â· <span class="${left>0?'':'full'}">${left>0? left+' vrij':'VOL'}</span></div>
    `;
    els.availability.appendChild(box);
  });
}
async function renderAvailability(){ const c = await getEffectiveCounts(); drawAvailability(c); }
function renderLessonOptions(){
  els.lessonSel.innerHTML = `<option value="">Kies een proeflesmomentâ€¦</option>`;
  const select = els.lessonSel;
  const grouped = { CVD:[], DBI:[] };
  CONFIG.lessons.forEach(l => grouped[l.track].push(l));
  ["CVD","DBI"].forEach(track => {
    const og = document.createElement("optgroup");
    og.label = track === "CVD" ? "CVD â€“ Creating Value for Data" : "DBI â€“ Digital Business Innovation";
    grouped[track].forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.id; opt.textContent = l.name;
      og.appendChild(opt);
    });
    select.appendChild(og);
  });
}

/* ===== Profiel state ===== */
let currentProfile = null; // {sid, name, email, track}
async function lookupSidUI(){
  const sid = normSid(els.sid.value);
  if(!sid) return;
  try{
    const data = await apiGet({ op:"lookupSid", sid });
    if(data.ok){
      currentProfile = data.profile || null;
      setTrackUI(currentProfile);
      if (data.activeCount >= CONFIG.MAX_BOOKINGS_PER_SID) {
        msg(`Je hebt het maximum van ${CONFIG.MAX_BOOKINGS_PER_SID} boekingen bereikt. Annuleer eerst Ã©Ã©n boeking.`, true);
      }
    }
  }catch(e){ /* ignore */ }
}
function setTrackUI(profile){
  if(profile && profile.track){
    els.trackBlock.style.display = "none";
    els.trackLock.style.display = "block";
    els.trackFixed.value = profile.track;
    if(profile.email && !els.email.value) els.email.value = profile.email;
    if(profile.name && !els.name.value) els.name.value = profile.name;
  }else{
    els.trackBlock.style.display = "block";
    els.trackLock.style.display = "none";
    els.track.value = "";
  }
}

/* ===== Acties ===== */
function msg(text, isErr=false){ els.bookMsg.innerHTML = text; els.bookMsg.style.color = isErr ? '#fca5a5' : '#a7f3d0'; }

async function saveTrackOnce(){
  const sid = normSid(els.sid.value);
  const name = els.name.value.trim();
  const email = (els.email?.value || "").trim();
  const track = els.track.value;

  if(!sid || sid.length<5) return msg("Vul eerst een geldig studentnummer in (min. 5 cijfers).", true);
  if(!name) return msg("Vul je naam in om je track op te slaan.", true);
  if(!email || !isValidEmail(email)) return msg("Vul een geldige e-mail in.", true);
  if(!track) return msg("Kies een track.", true);

  const resp = await apiPost({ op:"profile", sid, name, email, track });
  if(!resp.ok){
    if(resp.error === "exists"){
      msg("Je track stond al vast. Ga verder met boeken.", false);
      currentProfile = resp.profile || { sid, name, email, track };
    } else {
      return msg("Kon track niet opslaan: "+(resp.error||"onbekend"), true);
    }
  }else{
    currentProfile = resp.profile;
  }
  setTrackUI(currentProfile);
  msg("Je track is opgeslagen. Je kunt nu boeken.");
}

async function book(){
  const name = els.name.value.trim();
  const sid = normSid(els.sid.value);
  const email = (els.email?.value || "").trim();
  const lessonId = els.lessonSel.value;

  if(!name || !sid || !lessonId) return msg("Vul naam, studentnummer en les in.", true);
  if(sid.length < 5) return msg("Studentnummer moet uit minimaal 5 cijfers bestaan.", true);
  if(!email || !isValidEmail(email)) return msg("Vul een geldige e-mail in.", true);

  if(!currentProfile || !currentProfile.track){
    return msg("Leg eerst je track vast (Ã©Ã©nmalig) en probeer daarna te boeken.", true);
  }

  const counts = await getEffectiveCounts();
  const l = lessonById(lessonId);
  if((counts[lessonId]||0) >= l.capacity) return msg("Dit lesmoment is VOL.", true);

  const code = uid(4);
  const resp = await apiPost({
    op:"add",
    lessonId,
    lessonName: l.name,
    name, sid, email,
    track: currentProfile.track,
    code,
    timestamp: new Date().toISOString()
  });
  if(!resp.ok){
    if(resp.error === "limit_reached"){
      return msg(`Je hebt het maximum van ${CONFIG.MAX_BOOKINGS_PER_SID} boekingen bereikt.`, true);
    }
    return msg("Boeken mislukt: "+(resp.error||"onbekend"), true);
  }

  const all = loadBookings();
  all.push({ name, sid, track: currentProfile.track, email, lessonId, code, ts: Date.now() });
  saveBookings(all);
  renderAvailabilityThrottled();
  refreshAdmin();

  msg(`Ingeschreven! Jouw annuleercode: <span class="code">${code}</span> (bewaar deze)`);
  els.lessonSel.value = "";
}

async function cancelOwn(){
  const sid = normSid(els.cancelSid.value);
  const code = els.cancelCode.value.trim().toUpperCase();
  if(!sid || !code){ alert("Vul studentnummer en code in."); return; }

  const resp = await apiPost({ op:"cancel", sid, code });
  if(!resp.ok){ alert("Annuleren in Google Sheet mislukte. Probeer opnieuw."); return; }

  let all = loadBookings();
  all = all.filter(b => !(normSid(b.sid)===sid && String(b.code||'').trim().toUpperCase()===code));
  saveBookings(all);

  renderAvailabilityThrottled();
  refreshAdmin();
  alert("Je boeking is geannuleerd.");
  els.cancelSid.value=""; els.cancelCode.value="";
}

/* ===== Admin ===== */
async function adminLogin(){
  const entered = els.adminCode.value;
  const ok = (await sha256Hex(entered)) === CONFIG.ADMIN_CODE_HASH;
  if(ok){ els.adminArea.style.display = "block"; refreshAdmin(); }
  else { alert("Onjuiste admin-code."); }
}
function refreshAdmin(){
  const list = loadBookings();
  els.adminStats.innerHTML = "";
  CONFIG.lessons.forEach(l=>{
    const used = list.filter(b=>b.lessonId===l.id).length;
    const div = document.createElement("div");
    div.innerHTML = `<div class="flex"><span class="badge ${l.track}">${l.track}</span>
      <strong>${l.name}</strong> <span class="muted">â€” ${used}/${l.capacity} (lokaal)</span></div>`;
    els.adminStats.appendChild(div);
  });
  els.adminTableBody.innerHTML = "";
  list.forEach((b,idx)=>{
    const l = lessonById(b.lessonId);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${l?l.name:'(verwijderd)'}</td>
      <td>${b.name}</td>
      <td>${b.sid}</td>
      <td>${b.track||''}</td>
      <td>${b.email||''}</td>
      <td><span class="code">${b.code}</span></td>
      <td class="right"><button class="btn danger" data-del="${idx}">Verwijder</button></td>
    `;
    els.adminTableBody.appendChild(tr);
  });
}
document.addEventListener("click", async (e)=>{
  const delIdx = e.target.getAttribute && e.target.getAttribute("data-del");
  if(delIdx!=null){
    const all = loadBookings();
    const row = all[Number(delIdx)];
    const lesNaam = lessonById(row.lessonId)?.name || '';
    if(!confirm(`Verwijderen:\n${row.name} (${row.sid})\n${lesNaam}?`)) return;
    const okResp = await apiPost({ op:"cancel", sid: row.sid, code: row.code });
    if(!okResp.ok){ alert("Annuleren in Google Sheet mislukte (rij blijft staan). Probeer opnieuw."); return; }
    all.splice(Number(delIdx),1); saveBookings(all);
    refreshAdmin(); renderAvailabilityThrottled();
  }
});

/* ===== Export/Import ===== */
function toCSV(rows){
  const header = ["lessonId","lessonName","track","name","sid","email","code","timestamp"];
  const csv = [header.join(",")].concat(rows.map(r=>{
    const l = lessonById(r.lessonId);
    const esc = s => `"${String(s||"").replace(/"/g,'""')}"`;
    return [ r.lessonId, l?l.name:"", r.track||"", r.name, r.sid, r.email||"", r.code, new Date(r.ts).toISOString() ].map(esc).join(",");
  })).join("\n");
  return csv;
}
function download(filename, content, type="text/plain"){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content], {type}));
  a.download = filename; a.click();
}
document.getElementById("exportCsv").addEventListener("click", ()=>{ download("proefstuderen.csv", toCSV(loadBookings()), "text/csv"); });
document.getElementById("exportJson").addEventListener("click", ()=>{ download("proefstuderen.json", JSON.stringify(loadBookings(), null, 2), "application/json"); });
document.getElementById("importJson").addEventListener("change", async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  let rows = []; try{ rows = JSON.parse(text); }catch(err){ alert("Geen geldige JSON."); return; }
  if(!Array.isArray(rows)) return alert("JSON verwacht een lijst.");
  const existing = loadBookings();
  const key = r => `${normSid(r.sid)}|${String(r.code||'').toUpperCase()}`;
  const map = new Map(existing.map(r=>[key(r), r]));
  rows.forEach(r=> map.set(key(r), r));
  const merged = Array.from(map.values());
  saveBookings(merged); refreshAdmin(); renderAvailabilityThrottled();
  alert("Import voltooid.");
});

/* ===== Wire-up & init ===== */
document.getElementById("saveTrackBtn").addEventListener("click", saveTrackOnce);
document.getElementById("sid").addEventListener("blur", lookupSidUI);
document.getElementById("bookBtn").addEventListener("click", book);
document.getElementById("cancelBtn").addEventListener("click", cancelOwn);
document.getElementById("loginBtn").addEventListener("click", adminLogin);

function init(){
  renderLessonOptions();
  renderAvailability();
}
init();
</script>
</body>
</html>
